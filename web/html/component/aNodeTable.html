{{define "component/nodeTable/content"}}
<template>
  <div>
    <a-button type="primary" @click="openCreate" style="margin-bottom:16px;">{{ i18n "create" }}</a-button>
    <a-table :data-source="nodes" :row-key="record => record.id" :pagination="false" :loading="loading">
      <a-table-column title="ID" dataIndex="id" key="id"></a-table-column>
      <a-table-column title="{{ i18n "name" }}" dataIndex="name" key="name"></a-table-column>
      <a-table-column title="API URL" dataIndex="apiUrl" key="apiUrl"></a-table-column>
      <a-table-column title="API Key" dataIndex="apiKey" key="apiKey"></a-table-column>
      <a-table-column title="{{ i18n "operate" }}" key="action" scopedSlots="{ customRender: 'action' }"></a-table-column>
      <template slot="action" slot-scope="text, record">
        <a-space>
          <a-button size="small" @click="openEdit(record)">{{ i18n "edit" }}</a-button>
          <a-popconfirm :title="'{{ i18n "delete" }}'" :ok-text="'{{ i18n "delete" }}'" :cancel-text="'{{ i18n "cancel" }}'" @confirm="remove(record.id)" :overlay-class-name="themeSwitcher.currentTheme">
            <a-button size="small" type="danger">{{ i18n "delete" }}</a-button>
          </a-popconfirm>
        </a-space>
      </template>
    </a-table>
    <a-modal v-model="modalVisible" :title="form.id ? '{{ i18n "edit" }}' : '{{ i18n "create" }}'" :ok-text="form.id ? '{{ i18n "update" }}' : '{{ i18n "create" }}'" :cancel-text="'{{ i18n "cancel" }}'" @ok="submit" :mask-closable="false">
      <a-form layout="vertical">
        <a-form-item :label="'{{ i18n "name" }}'">
          <a-input v-model="form.name"></a-input>
        </a-form-item>
        <a-form-item label="API URL">
          <a-input v-model="form.apiUrl"></a-input>
        </a-form-item>
        <a-form-item label="API Key">
          <a-input v-model="form.apiKey"></a-input>
        </a-form-item>
      </a-form>
    </a-modal>
  </div>
</template>
{{end}}

{{define "component/aNodeTable"}}
<script>
Vue.component('node-table', {
  data() {
    return {
      nodes: [],
      loading: false,
      modalVisible: false,
      form: { id: null, name: '', apiUrl: '', apiKey: '' }
    };
  },
  methods: {
    async load() {
      this.loading = true;
      const msg = await HttpUtil.get('/nodes');
      if (msg.success) {
        this.nodes = msg.obj || [];
      }
      this.loading = false;
    },
    openCreate() {
      this.form = { id: null, name: '', apiUrl: '', apiKey: '' };
      this.modalVisible = true;
    },
    openEdit(record) {
      this.form = Object.assign({}, record);
      this.modalVisible = true;
    },
    async submit() {
      let msg;
      if (this.form.id) {
        try {
          const resp = await axios.put(`/nodes/${this.form.id}`, this.form);
          msg = HttpUtil._respToMsg(resp);
          HttpUtil._handleMsg(msg);
        } catch (e) {
          console.error(e);
          return;
        }
      } else {
        msg = await HttpUtil.post('/nodes', this.form);
      }
      if (msg.success) {
        this.modalVisible = false;
        await this.load();
      }
    },
    async remove(id) {
      try {
        const resp = await axios.delete(`/nodes/${id}`);
        const msg = HttpUtil._respToMsg(resp);
        HttpUtil._handleMsg(msg);
        if (msg.success) {
          await this.load();
        }
      } catch (e) {
        console.error(e);
      }
    }
  },
  mounted() {
    this.load();
  },
  template: `{{template "component/nodeTable/content"}}`
});
</script>
{{end}}
